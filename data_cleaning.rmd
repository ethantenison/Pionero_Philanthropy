---
title: "Guatemalan Nonprofit Explorer"
author: "Ethan Tenison"
date: "12/18/2019"
output: html_document
---

## Load Libraries 


```{r libraries, message=FALSE, warning=FALSE}
# This will install the packages that you do not have installed on your computer. If you add new ones, you #need to add them to the list.of.packages list. 

list.of.packages <- c("raster", "sp", "sf", "labelled", "rgdal", "rio", "haven", 
                      "tidyverse", "geosphere", "mapview", "openxlsx", "janitor", 
                      "googlesheets4", "gargle", "googledrive", "dplyr")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

#load libraries 
library(raster)
library(sp)
library(sf)
library(labelled)
library(rgdal)
library(rio)
library(haven)
library(tidyverse)
library(geosphere) # library with lots of shape files
library(mapview) # incredible interactive map visualization in R
library(openxlsx)
library(janitor)
library(googlesheets4)
library(gargle)
library(googledrive)
library(dplyr)

```

## Reading in the data 


```{r data}
# read the shape file using sf package and transform the coordinate system 
guatemala.shape_orig <- st_read("data/GTM_adm1.shp", stringsAsFactors=FALSE)
Guatemala <- st_transform(guatemala.shape_orig, "+proj=longlat +ellps=WGS84 +datum=WGS84")

# using googlesheets4 package to call the data directly from the mapping dataset 
data <- read_sheet(ss= "https://docs.google.com/spreadsheets/d/1klJ0aUZF1HX8qwR8EjsOhWUB9EJH6PYYdzPl2fQUvuM/edit?usp=sharing", sheet = "MD", col_names = TRUE, guess_max = 30) # Here I had to set guess_max = 5 because it was reading in the longitude column as a list

data <- clean_names(data)


write.csv(data, file="data/data.csv", fileEncoding = "UTF-8" )
df <- read.csv("data/data.csv", fileEncoding = "UTF-8", encoding = "UTF-8", stringsAsFactors = FALSE)

```

## Convert from wide dataset to long  

```{r wide2long}
# In this part I am converting the data frame from wide to long 

data <- mutate(df, all_npos = "All Nonprofits")
data$health[data$health == "Y" ] <- "Health"
data$edu[data$edu == "Y" ] <- "Education"
data$comm_dev[data$comm_dev == "Y" ] <- "Community Development"
data$youth_child[data$youth_child == "Y" ] <- "Youth & Children"
data$women_girls[data$women_girls == "Y" ] <- "Women & Girls"
data$enviro_cons[data$enviro_cons == "Y" ] <- "Environment & Conservation"
data$crime[data$crime == "Y" ] <- "Crime"
data$human_rights[data$human_rights == "Y" ] <- "Human Rights"
data$animal_welfare[data$animal_welfare == "Y" ] <- "Animal Welfare"
data$faith_based[data$faith_based == "Y"] <- "Faith Based"

data$health[data$health == "N" ] <- NA
data$edu[data$edu == "N" ] <- NA
data$comm_dev[data$comm_dev == "N" ] <- NA
data$youth_child[data$youth_child == "N" ] <- NA
data$women_girls[data$women_girls == "N" ] <- NA
data$enviro_cons[data$enviro_cons == "N" ] <- NA
data$crime[data$crime == "N" ] <- NA
data$human_rights[data$human_rights == "N" ] <- NA
data$animal_welfare[data$animal_welfare == "N" ] <- NA
data$faith_based[data$faith_based == "N"] <- "Not Faith Based"

data <- data %>% unite(list_categories,health:faith_based, remove = FALSE, sep =", ",na.rm = TRUE)


data_1st_add <- data %>% dplyr::select(-c(address2,latitude2,longitude2,municipality2, department2, address3,latitude3, longitude3,
                                          municipality3, department3, address4,latitude4,longitude4,municipality4, department4,
                                          address5,latitude5, longitude5,municipality5, department5))

data_2nd_add <- data %>% dplyr::select(-c(address,latitude,longitude, municipality, department, address3                                
                                          ,latitude3, longitude3, municipality3, department3, address4,latitude4,                            
                                          longitude4,municipality4, department4, address5,latitude5, longitude5,                             
                                          municipality5, department5))  %>% rename(address = address2, latitude =                            
                                          latitude2, longitude = longitude2, municipality = municipality2,
                                          department = department2) 

data_3rd_add <- data %>% dplyr::select(-c(address,latitude,longitude, municipality, department, address2                                 
                                          ,latitude2, longitude2, municipality2, department2, address4,latitude4,                          
                                          longitude4,municipality4, department4, address5,latitude5, longitude5,                             
                                          municipality5, department5))  %>% rename(address = address3, latitude =                            
                                          latitude3, longitude = longitude3, municipality = municipality3,                              
                                          department = department3) 

data_4th_add <- data %>% dplyr::select(-c(address,latitude,longitude, municipality, department, address2                                
                                          ,latitude2, longitude2, municipality2, department2, address3,latitude3,                       
                                          longitude3,municipality3, department3, address5,latitude5, longitude5,                
                                          municipality5, department5))  %>% rename(address = address4, latitude =               
                                           latitude4, longitude = longitude4, municipality = municipality4,                             
                                           department = department4) 

data_5th_add <- data %>% dplyr::select(-c(address,latitude,longitude, municipality, department, address2                        
                                          ,latitude2, longitude2, municipality2, department2, address3,latitude3,                       
                                          longitude3,municipality3, department3, address4,latitude4, longitude4,                        
                                          municipality4, department4))  %>% rename(address = address5, latitude =                       
                                          latitude5, longitude = longitude5, municipality = municipality5,                                  
                                          department = department5) 

data <- do.call("rbind", list(data_1st_add,data_2nd_add,data_3rd_add,data_4th_add, data_5th_add))
data <- filter(data, !is.na(latitude))
data <- data[ , names(data) != "X"]

data <-pivot_longer(
        data,
        cols = c(
                "health",
                "edu",
                "comm_dev",
                "youth_child",
                "women_girls",
                "enviro_cons",
                "crime",
                "human_rights",
                "animal_welfare",
                "all_npos"
        ),
        names_to = "category",
        
)

data <- filter(data, !value %in% NA)
data <- filter(data, !value %in% "")
data <- dplyr::select(data, -c(category))
data <- rename(data, category = value)


```

```{r clickable_website}

 #data <- filter(data, !is.na(website))
 data$website <- paste0("<a href='",data$website,"' target='_blank'>","Click here","</a>")
 data$website <- gsub("<a href='NA' target='_blank'>Click here</a>", 'NA', data$website)
```

```{r size}



                data$size <- factor(data$size, levels=
                                       c("Nano","Micro","Small","Medium","Large"),
                                    exclude = NULL, ordered = TRUE)

```

```{r year}

        data$year_founded <- as.numeric(data$year_founded)
        
        
        
```


```{r partner_status}

        data$partner_status <- as.character(data$partner_status)

        data$partner_status[data$partner_status == "P" ] <- "Partnered"
        data$partner_status[data$partner_status == "E" ] <- "Eligible"
        data$partner_status[data$partner_status == "DP" ] <- "Discontinued Partnership"
        data$partner_status[data$partner_status == "NE" ] <- "Not Eligible"
        data$partner_status[is.na(data$partner_status)] <- "No Information"
        
        #changing it to an ordered factor 
        data$partner_status <- factor(data$partner_status, levels=
                                       c("Partnered","Eligible","Not Eligible", "Discontinued Partnership", "No Information"))
    
                
                

```
        
        
```{r altering_rearranging}

#Altering the size variable 
        data$budget <- str_replace_all(data$budget, "\\$", "")
        data$budget <- str_replace_all(data$budget, ",", "")
        data$budget <- as.numeric(data$budget)
        data <- mutate(data, budget_adj = budget)
        
        data$budget_adj[is.na(data$budget_adj)] <- 25000 
        
        data$yrs_old <- as.Date(as.character(data$year_founded), format = "%Y")
        today <- as.Date(Sys.Date(), format='%Y')
        data <- mutate(data, npo_age = lubridate::time_length(difftime(today, data$yrs_old), "years"))
        
        data <- mutate(data, constant = .5)
        
                
                
        data <- dplyr::select(data, npo,category,latitude, longitude, address, municipality, department, budget, budget_adj, size,
                       year_founded,npo_age, partner_status, constant, everything())
        
        data <- data %>% arrange(npo)
        data <- filter(data, !is.na(category))
        
        

```

```{r fixing_department_names}

data$department <- as.character(data$department)

data$department[data$department == "Péten" ] <- "Petén"
data$department[data$department == "Peten" ] <- "Petén"
data$department[data$department == "Solola" ] <- "Sololá"
data$department[data$department == "Suchitepequez" ] <- "Suchitepéquez"
data$department[data$department == "Sacatepequez" ] <- "Sacatepéquez"
data$department[data$department == "Quiche" ] <- "Quiché"
data$department[data$department == "Quezaltenango" ] <- "Quetzaltenango"
data$department[data$department == "Totonicapan" ] <- "Totonicapán"


```


```{r demographics}


demo <- read_sheet(ss= "https://docs.google.com/spreadsheets/d/1KKSd_gHdtlYTdN0jnOtI86eCnRHQwoiBa6cMH9LnTA4/edit#gid=0", 
                   sheet = "Sheet1", col_names = TRUE)

demo <- clean_names(demo)
write.csv(demo, file="data/demographics.csv", fileEncoding = "UTF-8" ) #Accents weren't working until I forced UTF encoding
demographics <- read.csv("data/demographics.csv", fileEncoding = "UTF-8", encoding = "UTF-8", stringsAsFactors = FALSE)

guatemala.dep_orig <- st_read("data/GTM_adm1.shp", stringsAsFactors=FALSE)
guatemala_departments <- st_transform(guatemala.dep_orig, "+proj=longlat +ellps=WGS84 +datum=WGS84")
guatemala_departments <- guatemala_departments %>% dplyr::mutate(same = 1) %>% dplyr::select(same, everything())

demographic_map <- left_join(demographics, guatemala_departments, by = c("department" = "NAME_1"))


demographic_map <- dplyr::select(demographic_map, -c(X))
demographic_map$population <- as.numeric(demographic_map$population)
demographic_map$forest_fires <- as.numeric(demographic_map$forest_fires)


columns <- colnames(demographic_map[2:33])

demographic_map <- gather(demographic_map, measure, value, columns, factor_key=FALSE)
demographic_map <- dplyr::select(demographic_map, department, measure, value, geometry)

demographic_map <- mutate(demographic_map, units = "")

for (i in 1:length(demographic_map$units)){
        if(demographic_map$measure[i] == "population"){        
                demographic_map$units[i] <- "Inhabitants"               
        }
        else if(demographic_map$measure[i] == "poverty"){        
                demographic_map$units[i] <- "% Below Poverty Line"              
        }
        else if(demographic_map$measure[i] == "extreme_poverty"){        
                demographic_map$units[i] <- "% Below Extreme Poverty Line"              
        }
        else if(demographic_map$measure[i] == "gross_birth_rate"){        
                demographic_map$units[i] <- "Births per 1,000 inhabitants"              
        }
        else if(demographic_map$measure[i] == "infant_mortality_rate"){        
                demographic_map$units[i] <- "Deaths per 1,000 births"  
        }
        else if(demographic_map$measure[i] == "low_birth_weight"){        
                demographic_map$units[i] <- "% births less than 2.5 kg"              
        }
        else if(demographic_map$measure[i] == "medically_attended_births"){        
                demographic_map$units[i] <- "% births attended by medics"              
        }
        else if(demographic_map$measure[i] == "public_center_births"){        
                demographic_map$units[i] <- "% births in medical centers"              
        }
        else if(demographic_map$measure[i] == "gross_death_rate"){        
                demographic_map$units[i] <- "Deaths per 1,000 inhabitants"              
        }
        else if(demographic_map$measure[i] == "death_external"){        
                demographic_map$units[i] <- "unknown units"              
        }
        else if(demographic_map$measure[i] == "death_diabetes"){        
                demographic_map$units[i] <- "Deaths from diabetes per 1,000 deaths"              
        }
        else if(demographic_map$measure[i] == "death_diarrhea"){        
                demographic_map$units[i] <- "# of deaths from diarrhea per 1,000 deaths"              
        }
        else if(demographic_map$measure[i] == "death_circulatory"){        
                demographic_map$units[i] <- "Deaths from ciruculatory illnesses per 1,000 deaths"              
        }
        else if(demographic_map$measure[i] == "death_respiratory"){        
                demographic_map$units[i] <- "Deaths from respiratory illnesses per 1,000 deaths"              
        }
        else if(demographic_map$measure[i] == "death_tuber"){        
                demographic_map$units[i] <- "Tuberculosis deaths per 1,000 deaths"              
        }
        else if(demographic_map$measure[i] == "death_hivaids"){        
                demographic_map$units[i] <- "HIV/AIDS deaths per 1,000 deaths"              
        }
        else if(demographic_map$measure[i] == "intrafamily_violence_rate" ){        
                demographic_map$units[i] <- "% who have experienced domestic violence"              
        }
        else if(demographic_map$measure[i] == "homicide_rate"){        
                demographic_map$units[i] <- "Homicides per 100,000 inhabitants"              
        }
        else if(demographic_map$measure[i] == "delinquent_injury_rate"){        
                demographic_map$units[i] <- "Delinquent Injuries per 100,000 inhabitants"              
        }
        else if(demographic_map$measure[i] == "robbery_rate"){        
                demographic_map$units[i] <- "Robberies per 100,000 inhabitants"              
        }
        else if(demographic_map$measure[i] == "rape_rate"){        
                demographic_map$units[i] <- "Rapes per 100,000 inhabitants"              
        }
        else if(demographic_map$measure[i] == "crimes_against_freedom_rate"){        
                demographic_map$units[i] <- "Unknown per 100,000 inhabitants"              
        }
        else if(demographic_map$measure[i] == "judicial_offense_rate"){        
                demographic_map$units[i] <- "Judicial Offenses per 100,000 inhabitants"              
        }
        else if(demographic_map$measure[i] == "literacy_rate15_24"){        
                demographic_map$units[i] <- "% Literate ages 15-24"              
        }
        else if(demographic_map$measure[i] == "female_paid_employees"){        
                demographic_map$units[i] <- "% Females paid employees"              
        }
        else if(demographic_map$measure[i] == "employment_rate"){        
                demographic_map$units[i] <- "% Employed"              
        }
        else if(demographic_map$measure[i] == "potable_water_access"){        
                demographic_map$units[i] <- "% access to portable water"              
        }
        else if(demographic_map$measure[i] == "improved_sanitation_access"){        
                demographic_map$units[i] <- "% access to improved sanitation"              
        }
        else if(demographic_map$measure[i] == "forest_fires"){        
                demographic_map$units[i] <- "# of Forest Fires"              
        }
        else if(demographic_map$measure[i] == "home_water_access"){        
                demographic_map$units[i] <- "% with water access at home"              
        }
        else if(demographic_map$measure[i] == "homes_no_santitation"){        
                demographic_map$units[i] <- "% with no sanitation at home"              
        }
        
}


saveRDS(demographic_map, file="./data/demographic_map.rds")

```


```{r saving}

saveRDS(data, file="./data/npo_data.rds")

```