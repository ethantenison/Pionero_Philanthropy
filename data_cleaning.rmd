---
title: "Guatemalan Nonprofit Explorer"
author: "Ethan Tenison"
date: "12/18/2019"
output: html_document
---

## Load Libraries 


```{r libraries, message=FALSE, warning=FALSE}
# This will install the packages that you do not have installed on your computer. If you add new ones, you #need to add them to the list.of.packages list. 

list.of.packages <- c("raster", "sp", "sf", "labelled", "rgdal", "rio", "haven", 
                      "tidyverse", "geosphere", "mapview", "openxlsx", "janitor", 
                      "googlesheets4", "gargle", "googledrive", "dplyr")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

#load libraries 
library(raster)
library(sp)
library(sf)
library(labelled)
library(rgdal)
library(rio)
library(haven)
library(dplyr)
library(geosphere) # library with lots of shape files
library(mapview) # incredible interactive map visualization in R
library(openxlsx)
library(janitor)
library(googlesheets4)
library(gargle)
library(googledrive)


```

## Reading in the data 


```{r data}
# read the shape file using sf package and transform the coordinate system 
guatemala.shape_orig <- st_read("data/GTM_adm1.shp", stringsAsFactors=FALSE)
Guatemala <- st_transform(guatemala.shape_orig, "+proj=longlat +ellps=WGS84 +datum=WGS84")

# using googlesheets4 package to call the data directly from the mapping dataset 
data <- read_sheet(ss= "https://docs.google.com/spreadsheets/d/1klJ0aUZF1HX8qwR8EjsOhWUB9EJH6PYYdzPl2fQUvuM/edit?usp=sharing", sheet = "MD", col_names = TRUE, col_types = "ccncccccnncccnncccnncccnncccnncccnccccccccccccccccccccc") # Here I had to set guess_max = 5 because it was reading in the longitude column as a list

data <- clean_names(data)


write.csv(data, file="data/data.csv", fileEncoding = "UTF-8" )
#df <- read_csv("data/data.csv", col_types = cols(guate_govt_funding = col_character(), 
#   seal_excellence = col_character()), locale = locale(encoding = "UTF-8"))
df <- read.csv("data/data.csv", fileEncoding = "UTF-8", encoding = "UTF-8", stringsAsFactors = FALSE, colClasses=c("guate_govt_funding"="character", "seal_excellence"="character", "total_eval_score" = "character","efficiency" = "character","transparency" = "character", "relevance" = "character","impact" = "character", "sustainability" = "character"))

```

## Convert from wide dataset to long  

```{r wide2long}
# In this part I am converting the data frame from wide to long 

data <- mutate(df, all_npos = "All Nonprofits")
data$health[data$health == "Y" ] <- "Health"
data$edu[data$edu == "Y" ] <- "Education"
data$comm_dev[data$comm_dev == "Y" ] <- "Community Development"
data$youth_child[data$youth_child == "Y" ] <- "Youth & Children"
data$women_girls[data$women_girls == "Y" ] <- "Women & Girls"
data$enviro_cons[data$enviro_cons == "Y" ] <- "Environment & Conservation"
data$security[data$security == "Y" ] <- "Security"
data$human_rights[data$human_rights == "Y" ] <- "Human Rights"
data$animal_welfare[data$animal_welfare == "Y" ] <- "Animal Welfare"
data$faith_based[data$faith_based == "Y"] <- "Faith Based"
data$guate_govt_funding[data$guate_govt_funding == "Y"] <- "Yes"

data$health[data$health == "N" ] <- NA
data$edu[data$edu == "N" ] <- NA
data$comm_dev[data$comm_dev == "N" ] <- NA
data$youth_child[data$youth_child == "N" ] <- NA
data$women_girls[data$women_girls == "N" ] <- NA
data$enviro_cons[data$enviro_cons == "N" ] <- NA
data$security[data$security == "N" ] <- NA
data$human_rights[data$human_rights == "N" ] <- NA
data$animal_welfare[data$animal_welfare == "N" ] <- NA
data$guate_govt_funding[is.na(data$guate_govt_funding)] <- "No"
data$guate_govt_funding[data$guate_govt_funding == "N"] <- "No"
data$faith_based[data$faith_based == "N"] <- "Secular"
data$faith_based[is.na(data$faith_based)] <- "No information"
data$religious_aff[data$religious_aff == "None"] <- "Secular"
data$religious_aff[is.na(data$religious_aff)] <- "No information"

data <- data %>% unite(list_categories,health:animal_welfare, remove = FALSE, sep =", ",na.rm = TRUE)
data <- data %>% mutate(Tax_Registration = "Not Available")
data$us_tax_status[data$us_tax_status == "N"] <- NA
data$us_tax_status[data$us_tax_status == "Y"] <- "501(c)3"
data$us_tax_status[data$us_tax_status == "Yes"] <- "501(c)3"
data$guate_reg[data$guate_reg == "Asso"] <- "Guatemalan Association"
data$guate_reg[data$guate_reg == "NGO"] <- "Guatemalan NGO"
data$guate_reg[data$guate_reg == "Found"] <- "Foundation"
data$guate_reg[data$guate_reg == "N"] <- NA
data <- data %>% unite(tax_details, us_tax_status:guate_reg, remove = FALSE, sep =", ",na.rm = TRUE)


for (i in 1:length(data$Tax_Registration)){
                  if(!is.na(data$guate_reg[i]) & !is.na(data$us_tax_status[i])){        
                    data$Tax_Registration[i] <- "US & Guatemala"
                  }
                 else if(is.na(data$guate_reg[i]) & !is.na(data$us_tax_status[i])){        
                    data$Tax_Registration[i] <- "US only"
                 }
                else if(!is.na(data$guate_reg[i]) & is.na(data$us_tax_status[i])){        
                    data$Tax_Registration[i] <- "Guatemala only"
                 }
}




data_1st_add <- data %>% dplyr::select(-c(address2,latitude2,longitude2,municipality2, department2, address3,latitude3, longitude3,
                                          municipality3, department3, address4,latitude4,longitude4,municipality4, department4,
                                          address5,latitude5, longitude5,municipality5, department5))

data_2nd_add <- data %>% dplyr::select(-c(address,latitude,longitude, municipality, department, address3                                
                                          ,latitude3, longitude3, municipality3, department3, address4,latitude4,                            
                                          longitude4,municipality4, department4, address5,latitude5, longitude5,                             
                                          municipality5, department5))  %>% rename(address = address2, latitude =                            
                                          latitude2, longitude = longitude2, municipality = municipality2,
                                          department = department2) 

data_3rd_add <- data %>% dplyr::select(-c(address,latitude,longitude, municipality, department, address2                                 
                                          ,latitude2, longitude2, municipality2, department2, address4,latitude4,                          
                                          longitude4,municipality4, department4, address5,latitude5, longitude5,                             
                                          municipality5, department5))  %>% rename(address = address3, latitude =                            
                                          latitude3, longitude = longitude3, municipality = municipality3,                              
                                          department = department3) 

data_4th_add <- data %>% dplyr::select(-c(address,latitude,longitude, municipality, department, address2                                
                                          ,latitude2, longitude2, municipality2, department2, address3,latitude3,                       
                                          longitude3,municipality3, department3, address5,latitude5, longitude5,                
                                          municipality5, department5))  %>% rename(address = address4, latitude =               
                                           latitude4, longitude = longitude4, municipality = municipality4,                             
                                           department = department4) 

data_5th_add <- data %>% dplyr::select(-c(address,latitude,longitude, municipality, department, address2                        
                                          ,latitude2, longitude2, municipality2, department2, address3,latitude3,                       
                                          longitude3,municipality3, department3, address4,latitude4, longitude4,                        
                                          municipality4, department4))  %>% rename(address = address5, latitude =                       
                                          latitude5, longitude = longitude5, municipality = municipality5,                                  
                                          department = department5) 

data <- do.call("rbind", list(data_1st_add,data_2nd_add,data_3rd_add,data_4th_add, data_5th_add))
data <- filter(data, !is.na(latitude))
data <- data[ , names(data) != "X"]

data <-pivot_longer(
        data,
        cols = c(
                "health",
                "edu",
                "comm_dev",
                "youth_child",
                "women_girls",
                "enviro_cons",
                "security",
                "human_rights",
                "animal_welfare",
                "all_npos"
        ),
        names_to = "category",
        
)


data <- filter(data, !value %in% NA)
data <- filter(data, !value %in% "")
data <- filter(data, !latitude %in% NA)
data <- filter(data, !latitude %in% "")
data <- dplyr::select(data, -c(category))
data <- rename(data, category = value)

for (i in 1:length(data$category)){
                  if(data$list_categories[i] == ""){        
                    data$category[i] <- "Uncategorized"
                  }
}

data <- filter(data, category != "All Nonprofits")
```

```{r clickable_website}

#data <- filter(data, !is.na(website))

#data$website[is.na(data$website)] <- "https://www.google.com/"


for (i in 1:length(data$website)){
                  if(data$website[i] != "No"){        
                    data$website[i] <- paste0('<a href=\"',data$website[i],"\" target=\"_blank\">",data$npo[i],'</a>')
                  }
                  else {
                    data$website[i] <- data$npo[i] 
                  }
}

#data$website <- paste0('<a href=\"',data$website,"\" target=\"_blank\">",data$npo,'</a>')
```

```{r npo_size}

                data$size[is.na(data$size)] <- "No Information"

                data$size <- factor(data$size, levels=
                                       c("Nano","Micro","Small","Medium","Large", "No Information"),
                                    exclude = NULL, ordered = TRUE)

```

```{r year}

        data$year_founded <- as.numeric(data$year_founded)
        
        
        
```


```{r partner_status}

        data$partner_status <- as.character(data$partner_status)

        data$partner_status[data$partner_status == "P" ] <- "Partnered"
        data$partner_status[data$partner_status == "E" ] <- "Eligible"
        data$partner_status[data$partner_status == "DP" ] <- "Discontinued Partnership"
        data$partner_status[data$partner_status == "NE" ] <- "Not Eligible"
        data$partner_status[is.na(data$partner_status)] <- "No Information"
        
        #changing it to an ordered factor 
        data$partner_status <- factor(data$partner_status, levels=
                                       c("Partnered","Eligible","Not Eligible", "Discontinued Partnership", "No Information"))
    
                
                

```



```{r eligibility_restrictions}

data$ne_dp_reason[data$ne_dp_reason == "Y"] <- "None"
data$ne_dp_reason[data$ne_dp_reason == "E"] <- "None"
data$ne_dp_reason[data$ne_dp_reason == "NC"] <- "Not eligible because nonprofit has closed"
data$ne_dp_reason[data$ne_dp_reason == "NBL"] <- "Exceeds budget limit"
data$ne_dp_reason[data$ne_dp_reason == "NPI"] <- "No public online information available"
data$ne_dp_reason[data$ne_dp_reason == "NPi"] <- "No public online information available"
data$ne_dp_reason[data$ne_dp_reason == "NRA"] <- "Recent activity exceeds parameters"
data$ne_dp_reason[is.na(data$ne_dp_reason)] <- "Unknown"




```
        
        
```{r altering_rearranging}

#Altering the size variable 
library(stringr)

        data$budget <- str_replace_all(data$budget, "\\$", "")
        data$budget <- str_replace_all(data$budget, ",", "")
        data$budget <- as.numeric(data$budget)
        data <- mutate(data, budget_adj = budget)
        data$budget_adj[is.na(data$budget_adj)] <- 25000 
        
        data$yrs_old <- as.Date(as.character(data$year_founded), format = "%Y")
        today <- as.Date(Sys.Date(), format='%Y')
        data <- mutate(data, npo_age = lubridate::time_length(difftime(today, data$yrs_old), "years"))
        data <- mutate(data, npo_age_adj = npo_age)
        data$npo_age_adj[is.na(data$npo_age_adj)] <- 1 
        
        data <- mutate(data, total_eval_score_adj = total_eval_score)
        data$total_eval_score_adj[is.na(data$total_eval_score_adj)] <- 1
        
        
        data <- mutate(data, constant_size = 1)
        data <- mutate(data, constant_color = 1)
            
        data <- dplyr::select(data, npo,category,latitude, longitude, address, municipality, department, budget, budget_adj, size,
                   year_founded,npo_age, partner_status,ne_dp_reason, constant_size,constant_color, everything())
        
        data <- data %>% arrange(npo)
        data <- filter(data, !is.na(category))
        
        data$npo <- gsub("\"", "", data$npo)

```

```{r fixing_department_names}

data$department <- as.character(data$department)

data$department[data$department == "Péten" ] <- "Petén"
data$department[data$department == "Peten" ] <- "Petén"
data$department[data$department == "Solola" ] <- "Sololá"
data$department[data$department == "Suchitepequez" ] <- "Suchitepéquez"
data$department[data$department == "Sacatepequez" ] <- "Sacatepéquez"
data$department[data$department == "Quiche" ] <- "Quiché"
data$department[data$department == "Quezaltenango" ] <- "Quetzaltenango"
data$department[data$department == "Totonicapan" ] <- "Totonicapán"


```


```{r demographics}


demo <- read_sheet(ss= "https://docs.google.com/spreadsheets/d/1KKSd_gHdtlYTdN0jnOtI86eCnRHQwoiBa6cMH9LnTA4/edit#gid=0", 
                   sheet = "Sheet1", col_names = TRUE) #I had to set the NA values in forest fires and home water access to 0


write.csv(demo, file="data/demographics.csv", fileEncoding = "UTF-8" ) #Accents weren't working until I forced UTF encoding
demographics <- read.csv("data/demographics.csv", fileEncoding = "UTF-8", encoding = "UTF-8", stringsAsFactors = FALSE)

#Normalizing libraries to be per 1000 residents and creating a nothing selected variable 
demographics <- demographics %>% mutate("Nothing Selected"= NA) %>% dplyr::select(-c(X,Number.of.Preprimary.School.Students, Number.of.Primary.School.Students, Number.of.Middle.School.Students,Number.of.High.School.Students )) %>% mutate(Number.of.Libraries = Number.of.Libraries/(Population/100000))
to_paste <- demographics %>% dplyr::select(Department, Population, Poverty.Rate, Total.Literacy.Rate, Homicide.Rate, Total.Employment.Rate, Improved.Sanitation.Access, Gross.Birth.Rate)
demographics <- gather(demographics, measure, value, Population:"Nothing Selected")


guatemala.dep_orig <- st_read("data/GTM_adm1.shp", stringsAsFactors=FALSE)
guatemala_departments <- st_transform(guatemala.dep_orig, "+proj=longlat +ellps=WGS84 +datum=WGS84")
guatemala_departments <- guatemala_departments %>% dplyr::select(NAME_1,geometry)

demographic_map <- left_join(demographics, guatemala_departments, by = c("Department" = "NAME_1"))
demographic_map <- dplyr::select(demographic_map, Department, measure, value, geometry)
demographic_map <- left_join(demographic_map, to_paste, by = "Department")
demographic_map <- mutate(demographic_map, units = "%")
for (i in 1:length(demographic_map$measure)){
                  if(demographic_map$measure[i] == "Population"){        
                    demographic_map$units[i] <- ""
                  }
                 else if(demographic_map$measure[i] == "Nothing Selected"){        
                    demographic_map$units[i] <- ""
                  }
                  else if(demographic_map$measure[i] == "Forest.Fires"){        
                    demographic_map$units[i] <- "(hectares)"
                  }
                  else if(demographic_map$measure[i] == "People.in.Household"){        
                    demographic_map$units[i] <- ""
                  }
                 else if(demographic_map$measure[i] == "Number.of.Libraries"){        
                    demographic_map$units[i] <- "per 100,000 people"
                 }
                  else if(demographic_map$measure[i] == "Total.Years.of.Schooling"){        
                    demographic_map$units[i] <- ""
                  }
                 else if(demographic_map$measure[i] == "Female.Years.of.Schooling"){        
                    demographic_map$units[i] <- ""
                 }
                else if(demographic_map$measure[i] == "Male.Years.of.Schooling"){        
                                demographic_map$units[i] <- ""
                }else if(demographic_map$measure[i] == "Time.to.Primary.School"){        
                                demographic_map$units[i] <- "(minutes)"
                }else if(demographic_map$measure[i] == "Time.to.Secondary.School"){        
                                demographic_map$units[i] <- "(minutes)"
                }
                else if(demographic_map$measure[i] == "Gross.Birth.Rate"){        
                                                demographic_map$units[i] <- "(births/1,000)"
                }
                else if(demographic_map$measure[i] == "Infant.Mortality.Rate"){        
                                                demographic_map$units[i] <- "(deaths/1,000)"
                }
                else if(demographic_map$measure[i] == "Gross.Death.Rate"){        
                                                demographic_map$units[i] <- "(deaths/1,000)"
                }
                else if(demographic_map$measure[i] == "Gross.Death.Rate"){        
                                                demographic_map$units[i] <- "(deaths/1,000)"
                }
                else if(demographic_map$measure[i] == "Death.by.Diabetes"){        
                                                demographic_map$units[i] <- "(deaths/1,000)"
                }
                else if(demographic_map$measure[i] == "Death.by.Diarrhea"){        
                                                demographic_map$units[i] <- "(deaths/1,000)"
                }
                else if(demographic_map$measure[i] == "Death.by.Circulatory.System.Diseases"){        
                                                demographic_map$units[i] <- "(deaths/1,000)"
                            }
                else if(demographic_map$measure[i] == "Death.by.Respiratory.System.Diseases"){        
                                                            demographic_map$units[i] <- "(deaths/1,000)"
                }
                else if(demographic_map$measure[i] == "Death.by.Tuberculosis"){        
                                                            demographic_map$units[i] <- "(deaths/1,000)"
                }
                else if(demographic_map$measure[i] == "Death.by.HIV.AIDS"){        
                                                            demographic_map$units[i] <- "(deaths/1,000)"
                }
                else if(demographic_map$measure[i] == "Intrafamily.Violence"){        
                                                            demographic_map$units[i] <- ""
                }
                else if(demographic_map$measure[i] == "Homicide.Rate"){        
                                                            demographic_map$units[i] <- "(per 100,000)"
                }
                else if(demographic_map$measure[i] == "Delinquent.Injury.Rate"){        
                                                            demographic_map$units[i] <- "(per 100,000)"
                }
                else if(demographic_map$measure[i] == "Robbery.Rate"){        
                                                            demographic_map$units[i] <- "(per 100,000)"
                }
                else if(demographic_map$measure[i] == "Rape.Rate"){        
                                                            demographic_map$units[i] <- "(per 100,000)"
                            }
                  
}


library(stringr)
demographic_map$measure <- str_replace_all(demographic_map$measure, "\\.", " ")

demographic_map$measure[demographic_map$measure == "Population 65 "] <- "Population 65+"
demographic_map$measure[demographic_map$measure == "Homes Without Santitation Systems"] <- "Homes without Santitation Systems"



saveRDS(demographic_map, file="./data/demographic_map.rds")

```


```{r saving}

saveRDS(data, file="./data/npo_data.rds")

```




