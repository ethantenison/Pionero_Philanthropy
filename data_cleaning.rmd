---
title: "Guatemalan Nonprofit Explorer"
author: "Ethan Tenison"
date: "12/18/2019"
output: html_document
---

## Load Libraries 


```{r libraries, message=FALSE, warning=FALSE}
# This will install the packages that you do not have installed on your computer. If you add new ones, you #need to add them to the list.of.packages list. 

list.of.packages <- c("raster", "sp", "sf", "labelled", "rgdal", "rio", "haven", 
                      "tidyverse", "geosphere", "mapview", "openxlsx", "janitor", 
                      "googlesheets4", "gargle", "googledrive", "dplyr")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

#load libraries 
library(raster)
library(sp)
library(sf)
library(labelled)
library(rgdal)
library(rio)
library(haven)
library(tidyverse)
library(geosphere) # library with lots of shape files
library(mapview) # incredible interactive map visualization in R
library(openxlsx)
library(janitor)
library(googlesheets4)
library(gargle)
library(googledrive)
library(dplyr)

```

## Reading in the data 


```{r data}
# read the shape file using sf package and transform the coordinate system 
guatemala.shape_orig <- st_read("Guatemala_shape_files/GTM_adm1.shp", stringsAsFactors=FALSE)
Guatemala <- st_transform(guatemala.shape_orig, "+proj=longlat +ellps=WGS84 +datum=WGS84")

# using googlesheets4 package to call the data directly from the mapping dataset 
data <- read_sheet(ss= "https://docs.google.com/spreadsheets/d/1klJ0aUZF1HX8qwR8EjsOhWUB9EJH6PYYdzPl2fQUvuM/edit?usp=sharing", sheet = "Sheet1", col_names = TRUE, guess_max = 5) # Here I had to set guess_max = 5 because it was reading in the longitude column as a list

data <- clean_names(data)


write.csv(data, file="data.csv", fileEncoding = "UTF-8" )
data <- read.csv("data.csv", fileEncoding = "UTF-8", encoding = "UTF-8", stringsAsFactors = FALSE)

```

## Convert from wide dataset to long  

```{r wide2long}
# In this part I am converting the data frame from wide to long 

data <- mutate(data, all_npos = "All Nonprofits")
data$health[data$health == "Y" ] <- "Health"
data$edu[data$edu == "Y" ] <- "Education"
data$comm_dev[data$comm_dev == "Y" ] <- "Community Development"
data$youth_child[data$youth_child == "Y" ] <- "Youth & Children"
data$women_girls[data$women_girls == "Y" ] <- "Women & Girls"
data$enviro_cons[data$enviro_cons == "Y" ] <- "Environment & Conservation"
data$crime[data$crime == "Y" ] <- "Crime"
data$human_rights[data$human_rights == "Y" ] <- "Human Rights"
data$animal_welfare[data$animal_welfare == "Y" ] <- "Animal Welfare"
data$faith_based[data$faith_based == "Y"] <- "Faith Based"


data_1st_add <- data %>% dplyr::select(-c(address2,latitude2,longitude2,municipality2, department2, address3,latitude3, longitude3,
                                          municipality3, department3, address4,latitude4,longitude4,municipality4, department4,
                                          address5,latitude5, longitude5,municipality5, department5))

data_2nd_add <- data %>% dplyr::select(-c(address,latitude,longitude, municipality, department, address3                                
                                          ,latitude3, longitude3, municipality3, department3, address4,latitude4,                            
                                          longitude4,municipality4, department4, address5,latitude5, longitude5,                             
                                          municipality5, department5))  %>% rename(address = address2, latitude =                            
                                          latitude2, longitude = longitude2, municipality = municipality2,
                                          department = department2) 

data_3rd_add <- data %>% dplyr::select(-c(address,latitude,longitude, municipality, department, address2                                 
                                          ,latitude2, longitude2, municipality2, department2, address4,latitude4,                          
                                          longitude4,municipality4, department4, address5,latitude5, longitude5,                             
                                          municipality5, department5))  %>% rename(address = address3, latitude =                            
                                          latitude3, longitude = longitude3, municipality = municipality3,                              
                                          department = department3) 

data_4th_add <- data %>% dplyr::select(-c(address,latitude,longitude, municipality, department, address2                                
                                          ,latitude2, longitude2, municipality2, department2, address3,latitude3,                       
                                          longitude3,municipality3, department3, address5,latitude5, longitude5,                
                                          municipality5, department5))  %>% rename(address = address4, latitude =               
                                           latitude4, longitude = longitude4, municipality = municipality4,                             
                                           department = department4) 

data_5th_add <- data %>% dplyr::select(-c(address,latitude,longitude, municipality, department, address2                        
                                          ,latitude2, longitude2, municipality2, department2, address3,latitude3,                       
                                          longitude3,municipality3, department3, address4,latitude4, longitude4,                        
                                          municipality4, department4))  %>% rename(address = address5, latitude =                       
                                          latitude5, longitude = longitude5, municipality = municipality5,                                  
                                          department = department5) 

data <- do.call("rbind", list(data_1st_add,data_2nd_add,data_3rd_add,data_4th_add, data_5th_add))
data <- filter(data, !is.na(latitude))
data <- data[ , names(data) != "X"]

data <-pivot_longer(
        data,
        cols = c(
                "health",
                "edu",
                "comm_dev",
                "youth_child",
                "women_girls",
                "enviro_cons",
                "crime",
                "human_rights",
                "animal_welfare",
                "faith_based",
                "all_npos"
        ),
        names_to = "category",
        
)

data <- filter(data, !value %in% "N")
data <- filter(data, !value %in% "")
data <- dplyr::select(data, -c(category))
data <- rename(data, category = value)

```

```{r clickable_website}
 data$website <- paste0("<a href=\"",data$website,"\">","Click here","</a>")

```

```{r size}



                data$size <- factor(data$size, levels=
                                       c("Nano","Micro","Small","Medium","Large"),
                                    exclude = NULL, ordered = TRUE)

```

```{r yearcolor}

        data$year_founded <- as.numeric(data$year_founded)
        
        data_na <- filter(data, is.na(year_founded))
                data_na$year_founded_color <- "	#808080"
        
        data <- filter(data, year_founded != "NA")
                ii <- cut(data$year_founded, breaks = seq(min(data$year_founded), 
                        max(data$year_founded), len = 100), include.lowest = TRUE)
                
                data$year_founded_color <- colorRampPalette(c("#7c1d6f", "#fcde9c"))(99)[ii]
                
        data <- bind_rows(data, data_na)
        
        #setting it to factor 
        
        
```


```{r partner_status_color}

#color for partner status 
                

        
        data$partner_status <- as.character(data$partner_status)

        data$partner_status[data$partner_status == "P" ] <- "Partnered"
        data$partner_status[data$partner_status == "E" ] <- "Eligible"
        data$partner_status[data$partner_status == "DP" ] <- "Discontinued Partnership"
        data$partner_status[data$partner_status == "NE" ] <- "Not Eligible"
        
        #changing it to an ordered factor 
        data$partner_status <- factor(data$partner_status, levels=
                                       c("Partnered","Eligible","Not Eligible", "Discontinued Partnership"))
    
                
                

```
        
        
```{r altering_rearranging}

#Altering the size variable 
        data$budget <- str_replace_all(data$budget, "\\$", "")
        data$budget <- str_replace_all(data$budget, ",", "")
        data$budget <- as.numeric(data$budget)
        data <- mutate(data, budget_adj = budget)
        
        data$budget_adj[is.na(data$budget_adj)] <- 100000 
        
        data$yrs_old <- as.Date(as.character(data$year_founded), format = "%Y")
        today <- as.Date(Sys.Date(), format='%Y')
        data <- mutate(data, npo_age = lubridate::time_length(difftime(today, data$yrs_old), "years"))
        
                
                
        data <- dplyr::select(data, npo,category,latitude, longitude, address, municipality, department, budget, budget_adj, size, sizecolor,
                       year_founded,year_founded_color,npo_age, partner_status, partner_status_color, constant, constant_color, 
                       everything())
        
        data <- data %>% arrange(npo)
        
        
        

```


```{r saving}

saveRDS(data, file="./data/npo_data.rds")

```